<div class="message"
     [class.my-message]="isMyMessage(message)"
     [class.bot-message]="isBotMessage(message)"
     [class.other-message]="isOtherUserMessage(message)">

  @if (isMyMessage(message)) {
    <div class="message-avatar user-avatar">
      <app-user-display
        [user]="{ id: message.senderId || 'me', name: message.senderName || 'Me' }"
        [isOnline]="true"
        [size]="'small'"
        [showStatus]="false">
      </app-user-display>
    </div>
  }

  @if (isBotMessage(message)) {
    <div class="message-avatar">
      <div class="avatar bot-avatar">
        <span>ðŸ¤–</span>
      </div>
    </div>
  }

  @if (isOtherUserMessage(message)) {
    <div class="message-avatar">
      <app-user-display
        [user]="{ id: message.senderId || message.senderName || 'anonymous', name: message.senderName || 'Anonymous' }"
        [isOnline]="true"
        [size]="'small'"
        [showStatus]="false">
      </app-user-display>
    </div>
  }

  <div class="message-content">
    @if (message.senderName) {
      <div class="message-sender">
        {{ message.senderName }}
      </div>
    }

    <div class="message-bubble">
      <div class="message-bubble-content">
        @if (!isEditing) {
          <p class="message-text">{{ message.text }}</p>
        }

        @if (isEditing) {
          <div class="edit-container">
            <textarea
              class="edit-textarea"
              [(ngModel)]="editingText"
              (keydown)="onKeyDown($event)"
              placeholder="Edit your message..."
              #editTextarea
              rows="1">
            </textarea>
            <div class="edit-buttons">
              <button
                class="save-button"
                (click)="onSaveEdit()"
                title="Save changes"
                type="button">
                âœ“
              </button>
              <button
                class="cancel-button"
                (click)="cancelEdit()"
                title="Cancel editing"
                type="button">
                âœ•
              </button>
            </div>
          </div>
        }

        @if (isMyMessage(message) && !isEditing) {
          <button
            class="edit-button"
            (click)="onEditMessage()"
            title="Edit message"
            type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="m18.5 2.5 a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
        }
      </div>
      <div class="message-time">{{ formatTime(message.createdAt) }}</div>
    </div>
  </div>
</div>
